{% extends "base_dashboard.html" %}
{% block title %} | Fon Detay{% endblock %}
{% block sources %}    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/additional/profile.css')}}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>
{% endblock %}
{% block body %}

    <div class="dashboard container-fluid m-0 p-0" style="height: calc(100vh - 57px);">
        <div class="h-100 w-100 d-flex flex-column flex-lg-row">
            <div class="d-flex position-sticky bg-white sidebar bg-body-tertiary m-0 mb-lg-0 mb-3 p-0" style="min-height: 57px; border-right: solid 1px rgb(33, 37, 41, 0.25); border-bottom: solid 1px rgb(33, 37, 41, 0.25)">
                <div class="d-flex position-sticky w-100">
                    <ul class="nav nav-pills align-items-center justify-content-evenly flex-auto nav-flush mb-auto text-center flex-row flex-lg-column w-100">
                        <li class="nav-item w-100-lg">
                            <a href="/ana_panel" class="nav-link py-3 rounded-0" aria-current="page" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Ana Sayfa" data-bs-original-title="Ana Sayfa">
                                <i class="fa fa-home" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li class="w-100-lg">
                            <a href="/fon_ara" class="nav-link py-3 rounded-0" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Fon Ara" data-bs-original-title="Fon Ara">
                                <i class="fa fa-search" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li class="w-100-lg">
                            <a href="/portfoyum" class="nav-link py-3 rounded-0" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Portföyüm" data-bs-original-title="Portföyüm">
                                <i class="fa fa-pie-chart" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li class="w-100-lg">
                            <a href="/trend_analizi" class="nav-link py-3 rounded-0" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Trend Analiz Aracı" data-bs-original-title="Trend Analiz Aracı">
                                <i class="fa fa-bar-chart" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li class="w-100-lg">
                            <a href="/portfoy_simulasyonu" class="nav-link active py-3 rounded-0" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Portföy Simülasyonu" data-bs-original-title="Portföy Simülasyonu">
                                <i class="fa fa-line-chart" aria-hidden="true"></i>
                            </a>
                        </li>
                        <li class="w-100-lg">
                            <a href="/haberler" class="nav-link py-3 rounded-0" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Haberler" data-bs-original-title="Haberler">
                                <i class="fa fa-newspaper" aria-hidden="true"></i>
                            </a>
                        </li>
                    </ul>
                    
                </div>
                
            </div>

            <div class="w-100 h-100 d-flex flex-column justify-content-start px-4 py-4" style="overflow-y: scroll;">
                <div class="d-flex flex-row">
                    <form method="post" action="{{ url_for('portfoy_simulasyonu') }}" class="w-100 d-flex flex-column gap-3 py-4">
                        <div class="w-100" id="searchForm_1">
                            <div class="form-outline" data-mdb-input-init>
                                <label for="slider">Fon Seçin...</label>
                                {% if fund_code %}
                                    <input class="form-control w-100" type="text" id="fund_code_1" name="fund_code_1" placeholder="Fon Ara..." aria-label="Search" oninput="delayedSearchFunds_1()">
                                {% else %}
                                    <input class="form-control w-100" type="text" id="fund_code_1" name="fund_code_1" placeholder="Fon Ara..." aria-label="Search" oninput="delayedSearchFunds_1()">
                                {% endif %}
                            </div>
                            <div id="searchResults_1" class="list-group position-absolute w-100"></div>
                        </div>

                        <div class="form-group">
                            <label for="fund_percantage_1">Yüzde (%)</label>
                            <input type="text" id="fund_percantage_1" name="fund_percantage_1" class="fund_percantage_1" autocomplete="off" required>
                        </div>

                        <div class="w-100" id="searchForm_2">
                            <div class="form-outline" data-mdb-input-init>
                                <label for="slider">Fon Seçin...</label>
                                {% if fund_code %}
                                    <input class="form-control w-100" type="text" id="fund_code_2" name="fund_code_2" placeholder="Fon Ara..." aria-label="Search" oninput="delayedSearchFunds_2()">
                                {% else %}
                                    <input class="form-control w-100" type="text" id="fund_code_2" name="fund_code_2" placeholder="Fon Ara..." aria-label="Search" oninput="delayedSearchFunds_2()">
                                {% endif %}
                            </div>
                            <div id="searchResults_2" class="list-group position-absolute w-100"></div>
                        </div>

                        <div class="form-group">
                            <label for="fund_percantage_2">Yüzde (%)</label>
                            <input type="text" id="fund_percantage_2" name="fund_percantage_2" class="fund_percantage_2" autocomplete="off" required>
                        </div>

                        <div class="w-100" id="searchForm_3">
                            <div class="form-outline" data-mdb-input-init>
                                <label for="slider">Fon Seçin...</label>
                                {% if fund_code %}
                                    <input class="form-control w-100" type="text" id="fund_code_3" name="fund_code_3" placeholder="Fon Ara..." aria-label="Search" oninput="delayedSearchFunds_3()">
                                {% else %}
                                    <input class="form-control w-100" type="text" id="fund_code_3" name="fund_code_3" placeholder="Fon Ara..." aria-label="Search" oninput="delayedSearchFunds_3()">
                                {% endif %}
                            </div>
                            <div id="searchResults_3" class="list-group position-absolute w-100"></div>
                        </div>

                        <div class="form-group">
                            <label for="fund_percantage_3">Yüzde (%)</label>
                            <input type="text" id="fund_percantage_3" name="fund_percantage_3" class="fund_percantage_3" autocomplete="off" required>
                        </div>

                        <div class="form-group">
                            <label for="start_money">Başlangıç Parası</label>
                            <input type="text" id="start_money" name="start_money" class="form-control" autocomplete="off" required>
                        </div>

                        <div class="form-group">
                            <label for="datetimePicker">Tarih Seçiniz</label>
                            <input type="text" id="datetimePicker" name="datetimePicker" class="form-control" autocomplete="off" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Portföy Simülasyonunu Başlat</button>
                    </form>

                    <div class="container-xxl justify-content-center align-items-center">
                        <div class="d-flex flex-auto w-100 h-100">
                            <div id="figure" name="figure" class='w-100 h-100'></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="position-relative col col-lg-6">
                        <div id="figures_{{ 0 }}"></div>
                    </div>
                    <div class="position-relative col col-lg-6">
                        <div id="figures_{{ 1 }}"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="position-relative col col-lg-6">
                        <div id="figures_{{ 2 }}"></div>
                    </div>
                    <div class="position-relative col col-lg-6">
                        <div id="figures_{{ 3 }}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    var figure = {{ figure | safe }};

    var config = {"displayModeBar": false, "responsive": true};

    Plotly.setPlotConfig(config);

    // Ensure the 'figure' element exists before calling Plotly.newPlot
    document.addEventListener('DOMContentLoaded', function () {
        Plotly.newPlot('figure', figure, {});
    });
    
</script>

<script>
    var searchTimeout;

    function delayedSearchFunds_1() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(searchFunds_1, 500); // Adjust the delay (in milliseconds)
    }

    function delayedSearchFunds_2() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(searchFunds_2, 500); // Adjust the delay (in milliseconds)
    }

    function delayedSearchFunds_3() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(searchFunds_3, 500); // Adjust the delay (in milliseconds)
    }

    function searchFunds_1() {
        var fundName = document.getElementById('fund_code_1').value.trim().toUpperCase();

        // Check if the search query is not empty
        if (fundName === '') {
            // Clear results if the search query is empty
            var resultsDiv = document.getElementById('searchResults_1');
            resultsDiv.innerHTML = '';
            return;
        }

        // Make the API call to the Flask route
        fetch(`/search_funds?text=${encodeURIComponent(fundName)}`)
            .then(response => response.json())
            .then(data => {
                // Handle the data received from the Flask route
                displaySearchResults_1(data);
            })
            .catch(error => {
                // Handle errors
                console.error(error);
            });
    }

    function searchFunds_2() {
        var fundName = document.getElementById('fund_code_2').value.trim().toUpperCase();

        // Check if the search query is not empty
        if (fundName === '') {
            // Clear results if the search query is empty
            var resultsDiv = document.getElementById('searchResults_2');
            resultsDiv.innerHTML = '';
            return;
        }

        // Make the API call to the Flask route
        fetch(`/search_funds?text=${encodeURIComponent(fundName)}`)
            .then(response => response.json())
            .then(data => {
                // Handle the data received from the Flask route
                displaySearchResults_2(data);
            })
            .catch(error => {
                // Handle errors
                console.error(error);
            });
    }

    function searchFunds_3() {
        var fundName = document.getElementById('fund_code_3').value.trim().toUpperCase();

        // Check if the search query is not empty
        if (fundName === '') {
            // Clear results if the search query is empty
            var resultsDiv = document.getElementById('searchResults_3');
            resultsDiv.innerHTML = '';
            return;
        }

        // Make the API call to the Flask route
        fetch(`/search_funds?text=${encodeURIComponent(fundName)}`)
            .then(response => response.json())
            .then(data => {
                // Handle the data received from the Flask route
                displaySearchResults_3(data);
            })
            .catch(error => {
                // Handle errors
                console.error(error);
            });
    }

    function displaySearchResults_1(data) {
        var resultsDiv = document.getElementById('searchResults_1');
        resultsDiv.innerHTML = '';  // Clear previous results

        // Process and display the search results
        if (data && data.results) {
            data.results.forEach(function (result) {
                // Create a button instead of a link
                var resultItem = document.createElement('button');
                resultItem.type = 'button';
                resultItem.style.zIndex = 1231;
                resultItem.className = 'list-group-item list-group-item-action';
                // Set onclick to set the selected fund in the form
                resultItem.onclick = function() {
                    document.getElementById('fund_code_1').value = result.fund_code + ' - ' + result.fund_name;
                    // Optionally, you can close the search results dropdown
                    resultsDiv.innerHTML = '';
                };
                // Wrap the fund_code in a span with a class for styling
                resultItem.innerHTML = `<span class="text-primary text-decoration-none font-weight-bold">${result.fund_code}</span> - ${result.fund_name}`;
                resultsDiv.appendChild(resultItem);
            });
        } else {
            resultsDiv.textContent = 'No results found.';
        }
    }

    function displaySearchResults_2(data) {
        var resultsDiv = document.getElementById('searchResults_2');
        resultsDiv.innerHTML = '';  // Clear previous results

        // Process and display the search results
        if (data && data.results) {
            data.results.forEach(function (result) {
                // Create a button instead of a link
                var resultItem = document.createElement('button');
                resultItem.type = 'button';
                resultItem.style.zIndex = 1231;
                resultItem.className = 'list-group-item list-group-item-action';
                // Set onclick to set the selected fund in the form
                resultItem.onclick = function() {
                    document.getElementById('fund_code_2').value = result.fund_code + ' - ' + result.fund_name;
                    // Optionally, you can close the search results dropdown
                    resultsDiv.innerHTML = '';
                };
                // Wrap the fund_code in a span with a class for styling
                resultItem.innerHTML = `<span class="text-primary text-decoration-none font-weight-bold">${result.fund_code}</span> - ${result.fund_name}`;
                resultsDiv.appendChild(resultItem);
            });
        } else {
            resultsDiv.textContent = 'No results found.';
        }
    }

    function displaySearchResults_3(data) {
        var resultsDiv = document.getElementById('searchResults_3');
        resultsDiv.innerHTML = '';  // Clear previous results

        // Process and display the search results
        if (data && data.results) {
            data.results.forEach(function (result) {
                // Create a button instead of a link
                var resultItem = document.createElement('button');
                resultItem.type = 'button';
                resultItem.style.zIndex = 1231;
                resultItem.className = 'list-group-item list-group-item-action';
                // Set onclick to set the selected fund in the form
                resultItem.onclick = function() {
                    document.getElementById('fund_code_3').value = result.fund_code + ' - ' + result.fund_name;
                    // Optionally, you can close the search results dropdown
                    resultsDiv.innerHTML = '';
                };
                // Wrap the fund_code in a span with a class for styling
                resultItem.innerHTML = `<span class="text-primary text-decoration-none font-weight-bold">${result.fund_code}</span> - ${result.fund_name}`;
                resultsDiv.appendChild(resultItem);
            });
        } else {
            resultsDiv.textContent = 'No results found.';
        }
    }

    // Event listener to hide search results when clicking outside the search area
    document.addEventListener('click', function(event) {
        var searchForm = document.getElementById('searchForm_1');
        var searchResults = document.getElementById('searchResults_1');

        if (!searchForm.contains(event.target) && !searchResults.contains(event.target)) {
            // Clicked outside the search area, hide results
            searchResults.innerHTML = '';
        }
    });

    // Event listener to hide search results when clicking outside the search area
    document.addEventListener('click', function(event) {
        var searchForm = document.getElementById('searchForm_2');
        var searchResults = document.getElementById('searchResults_2');

        if (!searchForm.contains(event.target) && !searchResults.contains(event.target)) {
            // Clicked outside the search area, hide results
            searchResults.innerHTML = '';
        }
    });

    // Event listener to hide search results when clicking outside the search area
    document.addEventListener('click', function(event) {
        var searchForm = document.getElementById('searchForm_3');
        var searchResults = document.getElementById('searchResults_3');

        if (!searchForm.contains(event.target) && !searchResults.contains(event.target)) {
            // Clicked outside the search area, hide results
            searchResults.innerHTML = '';
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the datetime picker
        flatpickr("#datetimePicker", {
            enableTime: true,
            dateFormat: "d.m.Y", // Adjust the format as needed
            minDate: "18-11-2018", // Set the minimum date to today
        });
    });
</script>

<script>
    {% for i in range(0, 4) %}
        var figures_{{ i }} = {{ figures[i] | safe }};
        var config_{{ i }} = {"displayModeBar": false, "responsive": true};
        Plotly.setPlotConfig(config_{{ i }});
        Plotly.newPlot(`figures_{{ i }}`, figures_{{ i }}, {});
    {% endfor %}
</script>

{% endblock %}